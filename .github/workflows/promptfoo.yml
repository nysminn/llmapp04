name: promptfoo-tests

on:
  push:
    paths:
      - "promptfoo-tests/**"
      - "llm-python/**"   # because tests depend on backend behavior
  workflow_dispatch:

jobs:
  eval:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Start backend service (Docker)
        run: |
          docker build -t llm-python:ci ./llm-python
          docker run -d -p 8080:8080 --name llm-python-ci llm-python:ci
          sleep 5

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run PromptFoo classify evaluation
        working-directory: promptfoo-tests
        run: npx promptfoo@latest eval -c classify.yaml

      - name: Run PromptFoo sentiment evaluation
        working-directory: promptfoo-tests
        run: npx promptfoo@latest eval -c sentiment.yaml

      - name: Run PromptFoo summarize evaluation
        working-directory: promptfoo-tests
        run: npx promptfoo@latest eval -c summarize.yaml

      - name: Run PromptFoo intent evaluation
        working-directory: promptfoo-tests
        run: npx promptfoo@latest eval -c intent.yaml

      - name: Cleanup
        if: always()
        run: docker rm -f llm-python-ci
